apiVersion: toolhive.stacklok.dev/v1alpha1
kind: VirtualMCPServer
metadata:
  name: vmcp-demo
  namespace: toolhive-system
  annotations:
    toolhive.stacklok.dev/registry-export: "true"
    toolhive.stacklok.dev/registry-url: "http://$MCP_HOSTNAME/vmcp-demo/mcp"
    toolhive.stacklok.dev/registry-description: |
      Simple vMCP server with registry export enabled.
spec:
  config:
    groupRef: demo-tools
    telemetry:
      endpoint: mcp-collector.observability:4318
      insecure: true
      serviceName: vmcp-demo-server
      serviceVersion: "1.0.0"
      metricsEnabled: true
      tracingEnabled: true
      samplingRate: "1.0"
    aggregation:
      conflictResolution: prefix
      conflictResolutionConfig:
        prefixFormat: "{workload}_"
      tools:
        - workload: osv
          filter:
            # excludes the query_vulnerabilities_batch tool
            - "get_vulnerability"
            - "query_vulnerability"
        - workload: fetch
          overrides:
            fetch:
              name: fetch_internal_docs
              description: "Fetch internal documentation URLs from https://docs.stacklok.com."
  incomingAuth:
    type: anonymous
  outgoingAuth:
    source: inline
  serviceType: ClusterIP
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: vmcp-demo-route
  namespace: toolhive-system
spec:
  parentRefs:
    - name: traefik-gateway
      namespace: traefik
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /vmcp-demo
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: vmcp-vmcp-demo
          port: 4483
